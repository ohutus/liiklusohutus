<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<title>ULTRA COLLISION ENGINE</title>
<style>
body { margin:0; background:#000; overflow:hidden; color:white; font-family:Arial; }
canvas { background:#111; display:block; }
#ui { position:absolute; top:10px; left:10px; }
button { padding:6px; margin:3px; }
</style>
</head>
<body>

<div id="ui">
<button onclick="spawnAI()">Lisa AI auto</button>
<button onclick="reset()">Reset</button>
<div id="info"></div>
</div>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let keys = {};
document.addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);

let particles=[];
let shake=0;

class Particle{
    constructor(x,y){
        this.x=x; this.y=y;
        this.vx=(Math.random()-0.5)*1000;
        this.vy=(Math.random()-0.5)*1000;
        this.life=1;
    }
    update(dt){
        this.x+=this.vx*dt;
        this.y+=this.vy*dt;
        this.vx*=0.95;
        this.vy*=0.95;
        this.life-=dt;
    }
    draw(){
        ctx.globalAlpha=this.life;
        ctx.fillStyle="orange";
        ctx.fillRect(this.x,this.y,4,4);
        ctx.globalAlpha=1;
    }
}

class Car{
    constructor(x,y,a,player=false){
        this.x=x; this.y=y;
        this.angle=a;
        this.vx=0; this.vy=0;
        this.radius=25;
        this.mass=1500;
        this.health=100;
        this.player=player;
        this.color=player?"#00ffcc":"hsl("+Math.random()*360+",70%,50%)";
    }

    speed(){ return Math.hypot(this.vx,this.vy); }

    update(dt){
        let accel=0, turn=0;

        if(this.player){
            if(keys["w"]) accel=1000;
            if(keys["s"]) accel=-700;
            if(keys["a"]) turn=-4;
            if(keys["d"]) turn=4;
        } else {
            accel=600;

            // AI s√µidab keskele
            const cx=canvas.width/2;
            const cy=canvas.height/2;
            let target=Math.atan2(cy-this.y,cx-this.x);
            let diff=target-this.angle;
            diff=Math.atan2(Math.sin(diff),Math.cos(diff));
            turn=diff*2;
        }

        this.angle+=turn*dt;

        this.vx+=Math.cos(this.angle)*accel*dt;
        this.vy+=Math.sin(this.angle)*accel*dt;

        this.vx*=0.995;
        this.vy*=0.995;

        const maxSpeed=1500;
        const sp=this.speed();
        if(sp>maxSpeed){
            this.vx*=maxSpeed/sp;
            this.vy*=maxSpeed/sp;
        }

        this.x+=this.vx*dt;
        this.y+=this.vy*dt;

        // Seinad
        const m=50;
        if(this.x<m){ this.x=m; this.vx=Math.abs(this.vx)*0.6; }
        if(this.x>canvas.width-m){ this.x=canvas.width-m; this.vx=-Math.abs(this.vx)*0.6; }
        if(this.y<m){ this.y=m; this.vy=Math.abs(this.vy)*0.6; }
        if(this.y>canvas.height-m){ this.y=canvas.height-m; this.vy=-Math.abs(this.vy)*0.6; }
    }

    draw(){
        ctx.save();
        ctx.translate(this.x,this.y);
        ctx.rotate(this.angle);
        ctx.fillStyle=this.color;
        ctx.globalAlpha=Math.max(this.health/100,0.3);
        ctx.fillRect(-30,-15,60,30);
        ctx.restore();
        ctx.globalAlpha=1;
    }
}

let cars=[];
let player;

function init(){
    cars=[];
    particles=[];
    player=new Car(300,300,0,true);
    cars.push(player);
}
init();

function spawnAI(){
    cars.push(new Car(
        Math.random()*canvas.width,
        Math.random()*canvas.height,
        Math.random()*Math.PI*2,false
    ));
}

function reset(){ init(); }


// üí• P√ÑRIS F√ú√úSIKAGA KOKKUP√ïRGE
function resolveCollision(a,b){

    let dx=b.x-a.x;
    let dy=b.y-a.y;
    let dist=Math.hypot(dx,dy);

    if(dist===0) return;

    let overlap = a.radius + b.radius - dist;
    if(overlap>0){

        // NORMAL
        let nx=dx/dist;
        let ny=dy/dist;

        // POSITSIOONI KORREKTSIOON (l√ºkatakse eemale)
        let separation=overlap/2;
        a.x -= nx*separation;
        a.y -= ny*separation;
        b.x += nx*separation;
        b.y += ny*separation;

        // RELATIIVNE KIIRUS
        let rvx=b.vx-a.vx;
        let rvy=b.vy-a.vy;

        let velAlongNormal = rvx*nx + rvy*ny;
        if(velAlongNormal>0) return;

        let restitution=0.8; // p√µrke tugevus
        let impulse = -(1+restitution)*velAlongNormal;
        impulse/= (1/a.mass + 1/b.mass);

        let ix=impulse*nx;
        let iy=impulse*ny;

        a.vx -= ix/a.mass;
        a.vy -= iy/a.mass;
        b.vx += ix/b.mass;
        b.vy += iy/b.mass;

        // DAMAGE
        let impact=Math.abs(velAlongNormal);
        a.health-=impact*0.05;
        b.health-=impact*0.05;

        shake=Math.min(impact*2,40);

        for(let i=0;i<impact*2;i++){
            particles.push(new Particle((a.x+b.x)/2,(a.y+b.y)/2));
        }
    }
}

function update(dt){

    cars.forEach(c=>c.update(dt));

    for(let i=0;i<cars.length;i++){
        for(let j=i+1;j<cars.length;j++){
            resolveCollision(cars[i],cars[j]);
        }
    }

    particles.forEach(p=>p.update(dt));
    particles=particles.filter(p=>p.life>0);

    shake*=0.9;
}

function draw(){
    ctx.save();
    ctx.translate((Math.random()-0.5)*shake,
                  (Math.random()-0.5)*shake);

    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="#333";
    ctx.fillRect(canvas.width/2-80,0,160,canvas.height);
    ctx.fillRect(0,canvas.height/2-80,canvas.width,160);

    cars.forEach(c=>c.draw());
    particles.forEach(p=>p.draw());

    ctx.restore();
}

function loop(){
    update(0.016);
    draw();

    let kmh = player ? (player.speed()*3.6).toFixed(0) : 0;

    document.getElementById("info").innerText=
        "Autod: "+cars.length+
        " | Kiirus: "+kmh+" km/h"+
        " | Elu: "+player.health.toFixed(1);

    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>