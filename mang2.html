<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<title>DEFORM + REPLAY ENGINE</title>
<style>
body { margin:0; background:#000; overflow:hidden; color:white; font-family:Arial; }
canvas { background:#111; display:block; }
#ui { position:absolute; top:10px; left:10px; }
button { padding:6px; margin:3px; }
</style>
</head>
<body>

<div id="ui">
<button onclick="spawnAI()">Lisa AI</button>
<button onclick="reset()">Reset</button>
<div id="info"></div>
</div>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

canvas.width = 1600;
canvas.height = 900;
canvas.style.width = "100vw";
canvas.style.height = "100vh";

let keys = {};
document.addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);

let particles=[];
let cars=[];
let player;
let shake=0;

let history=[];
let replay=false;
let replayIndex=0;

class Particle{
    constructor(x,y){
        this.x=x;
        this.y=y;
        this.vx=(Math.random()-0.5)*1200;
        this.vy=(Math.random()-0.5)*1200;
        this.life=1;
    }
    update(dt){
        this.x+=this.vx*dt;
        this.y+=this.vy*dt;
        this.vx*=0.94;
        this.vy*=0.94;
        this.life-=dt;
    }
    draw(){
        ctx.globalAlpha=this.life;
        ctx.fillStyle="orange";
        ctx.fillRect(this.x,this.y,3,3);
        ctx.globalAlpha=1;
    }
}

class Car{
    constructor(x,y,a,player=false){
        this.x=x;
        this.y=y;
        this.angle=a;
        this.vx=0;
        this.vy=0;

        this.baseW=40;  // vÃ¤iksemad autod
        this.baseH=18;

        this.damage=0; // deformatsiooni tase

        this.radius=20;
        this.mass=1200;
        this.health=100;
        this.player=player;

        this.color=player?"#00ffcc":"hsl("+Math.random()*360+",70%,50%)";
    }

    speed(){ return Math.hypot(this.vx,this.vy); }

    update(dt){
        let accel=0, turn=0;

        if(this.player){
            if(keys["w"]) accel=1200;
            if(keys["s"]) accel=-800;
            if(keys["a"]) turn=-4;
            if(keys["d"]) turn=4;
        } else {
            accel=700;

            // AI liigub keskpunkti suunas
            let target=Math.atan2(canvas.height/2-this.y,canvas.width/2-this.x);
            let diff=target-this.angle;
            diff=Math.atan2(Math.sin(diff),Math.cos(diff));
            turn=diff*2;
        }

        this.angle+=turn*dt;

        this.vx+=Math.cos(this.angle)*accel*dt;
        this.vy+=Math.sin(this.angle)*accel*dt;

        this.vx*=0.995;
        this.vy*=0.995;

        const maxSpeed=1700;
        let sp=this.speed();
        if(sp>maxSpeed){
            this.vx*=maxSpeed/sp;
            this.vy*=maxSpeed/sp;
        }

        this.x+=this.vx*dt;
        this.y+=this.vy*dt;

        const m=40;
        if(this.x<m){ this.x=m; this.vx=Math.abs(this.vx)*0.6; }
        if(this.x>canvas.width-m){ this.x=canvas.width-m; this.vx=-Math.abs(this.vx)*0.6; }
        if(this.y<m){ this.y=m; this.vy=Math.abs(this.vy)*0.6; }
        if(this.y>canvas.height-m){ this.y=canvas.height-m; this.vy=-Math.abs(this.vy)*0.6; }
    }

    draw(){
        ctx.save();
        ctx.translate(this.x,this.y);
        ctx.rotate(this.angle);

        // ðŸ”¥ Deformatsioon
        let w=this.baseW*(1-this.damage*0.4);
        let h=this.baseH*(1+this.damage*0.3);

        ctx.fillStyle=this.color;
        ctx.fillRect(-w/2,-h/2,w,h);

        ctx.restore();ctx.beginPath();
ctx.arc(0,0,60,0,Math.PI*2);
ctx.strokeStyle="white";
ctx.lineWidth=3;
ctx.stroke();
    }
}

function resolveCollision(a,b){
    let dx=b.x-a.x;
    let dy=b.y-a.y;
    let dist=Math.hypot(dx,dy);
    if(dist===0) return;

    let overlap=a.radius+b.radius-dist;
    if(overlap>0){

        let nx=dx/dist;
        let ny=dy/dist;

        // eralda
        let sep=overlap/2;
        a.x-=nx*sep;
        a.y-=ny*sep;
        b.x+=nx*sep;
        b.y+=ny*sep;

        let rvx=b.vx-a.vx;
        let rvy=b.vy-a.vy;
        let vel=rvx*nx+rvy*ny;
        if(vel>0) return;

        let restitution=0.7;
        let impulse=-(1+restitution)*vel;
        impulse/=(1/a.mass+1/b.mass);

        let ix=impulse*nx;
        let iy=impulse*ny;

        a.vx-=ix/a.mass;
        a.vy-=iy/a.mass;
        b.vx+=ix/b.mass;
        b.vy+=iy/b.mass;

        let impact=Math.abs(vel);

        a.health-=impact*0.04;
        b.health-=impact*0.04;

        a.damage=Math.min(a.damage+impact*0.0005,1);
        b.damage=Math.min(b.damage+impact*0.0005,1);

        shake=Math.min(impact*2,35);

        for(let i=0;i<impact*1.5;i++){
            particles.push(new Particle((a.x+b.x)/2,(a.y+b.y)/2));
        }
    }
}

function init(){
    cars=[];
    particles=[];
    history=[];
    player=new Car(300,300,0,true);
    cars.push(player);
}
init();

function spawnAI(){
    cars.push(new Car(Math.random()*canvas.width,
                      Math.random()*canvas.height,
                      Math.random()*Math.PI*2,false));
}

function reset(){
    replay=false;
    replayIndex=0;
    init();
}

function toggleReplay(){
    replay=!replay;
    replayIndex=0;
}

function update(dt){

    if(!replay){
        history.push(JSON.parse(JSON.stringify(cars)));
        if(history.length>600) history.shift();
    }

    if(replay){
        if(history[replayIndex]){
            cars=JSON.parse(JSON.stringify(history[replayIndex]));
            replayIndex++;
        } else {
            replay=false;
        }
        return;
    }

    cars.forEach(c=>c.update(dt));

    for(let i=0;i<cars.length;i++){
        for(let j=i+1;j<cars.length;j++){
            resolveCollision(cars[i],cars[j]);
        }
    }

    particles.forEach(p=>p.update(dt));
    particles=particles.filter(p=>p.life>0);

    shake*=0.9;
}

function draw(){
    ctx.save();
    ctx.translate((Math.random()-0.5)*shake,
                  (Math.random()-0.5)*shake);

    ctx.clearRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="#333";
    ctx.fillRect(canvas.width/2-100,0,200,canvas.height);
    ctx.fillRect(0,canvas.height/2-100,canvas.width,200);

    cars.forEach(c=>c.draw());
    particles.forEach(p=>p.draw());

    ctx.restore();
}

function loop(){
    update(replay?0.008:0.016); // slow motion replay
    draw();

    let kmh=player?(player.speed()*3.6).toFixed(0):0;

    document.getElementById("info").innerText=
        "Autod: "+cars.length+
        " | Kiirus: "+kmh+" km/h"+
        " | Elu: "+player.health.toFixed(1)+
        (replay?" | REPLAY":"");

    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
